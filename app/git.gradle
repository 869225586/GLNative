def remoteBranch = "release/RB_2.1.1" //远端分支名
def errorMsg = "build failed : the sdk version code is error"
/**
 * 检查版本号 true从master 拉分支 false从 release 拉分支
 */
boolean checkVersion(String errorMsg) {
    def versions = ALLINONE_VERSION.toString().split("\\.")
    if (versions.size() != 4) {
        //版本号出错
        throw new Exception(errorMsg)
    }
    //判断是否需要
    if (versions[versions.size() - 1].toInteger() == 0) {
        //末尾是0 新版本 需要 拉分支 打tag
        return true
    } else {
        //判断前三位版本号是否一致
        def p = "git branch -a".execute()
        def remoteBranchs = []
        p.text.eachLine {
            if (it.contains("release/RB")) {
                int index = it.lastIndexOf("_")
                remoteBranchs = it.substring(index + 1).split("\\.")
            }
        }
        if (remoteBranchs.size() >= 3) {
            if (versions[0] == remoteBranchs[0] && versions[1] == remoteBranchs[1]
                    && versions[2] == remoteBranchs[2]) {

                return false
            } else {
                throw new Exception(errorMsg)
            }
        }


    }
}

def checkoutLocalBranch(String remoteBranchName, String errorMsg) {
    // 从某个远端分支 拉本地分支  并且打 tag
    if (true) {
        println("checkout branch from master")
        "git checkout -b release/RB_v2.1.1 origin/master".execute()
//        //从主分支拉 要打 Tag
        "git tag -a r/2.1.5 -m ''".execute()
        "git push origin r/2.1.5".execute()
    } else {
        //从release 分支拉
        println("checkout branch from release")
        "git checkout -b release/RB_v2.1.1 origin/${remoteBranchName}".execute()
    }

}

/**
 * 推送 version.txt 和 dependence.gradle 到git
 * @return
 */
def pushVersionAndGradlToGit(String remoteBranch) {
    def statusP = "git status".execute()
    println("git status:\n" + statusP.inputStream.text)
    statusP.waitFor()

    def addP = "git add app/git.gradle".execute()
    println("git add:\n" + addP.inputStream.text)
    addP.waitFor()


    def commitP = "git commit -m '版本测试'".execute()
    println("git commit:\n" + commitP.inputStream.text)
    commitP.waitFor()

    def pushP = "git push origin release/RB_v2.1.1:release/RB_v2.1.1".execute()
    println("git push:\n" + pushP.inputStream.text)
    pushP.waitFor()

    def tagP = "git tag -a v2.1.8 -m '版本提交'".execute()
    println("git tag:\n" + tagP.inputStream.text)
    tagP.waitFor()

    def pushTagP = "git push origin ${remoteBranch} v2.1.8".execute()
    println("git push tag:\n" + pushTagP.inputStream.text)
    pushTagP.waitFor()
}
/**
 * git推送 task
 */
task startGit {
    doLast {
//        checkoutLocalBranch(remoteBranch,errorMsg)
        pushVersionAndGradlToGit(remoteBranch)
    }
}


